var InputBackendMenu=api.InputBackendMenu=api.extendReactClass('MixinInput',{getInitialState:function(){return{items:null,itemListKey:api.Text.toId('itemList',true)};},componentWillMount:function(){this.parent();this.loadingSortableTimer&&clearTimeout(this.loadingSortableTimer);this.loadingSortableTimer=setTimeout(function(){api.Ajax.loadScript(api.urls.plugin+'/assets/vendors/sortable/html.sortable.min.js',this.forceUpdate.bind(this));}.bind(this),500);},render:function(){var items=this.state.items||(this.config?this.config.items:[]);if(!items.length){return React.createElement(api.ElementLoading,{inline:true});}return React.createElement('div',{ref:'mountedDOMNode',key:this.props.id||api.Text.toId(),className:'form-group '+(this.props.control['class']||this.props.control.className||'')},React.createElement('label',{className:this.props.control.labelClass||''},this.label,this.tooltip),React.createElement('div',{className:this.props.control.inputClass||''},React.createElement('div',{className:'card card-default'},React.createElement('div',{className:'card-header d-flex justify-content-between'},React.createElement('h3',{className:'card-title'},this.label),React.createElement('a',{href:'javascript:void(0)',onClick:this.addGroup},React.createElement('i',{className:'fa fa-plus'}))),React.createElement('div',{className:'card-body'},React.createElement('ul',{id:this.props.id+'_components',key:this.state.itemListKey,ref:'items',className:'item-list'},items.map((item,index)=>{var name=this.props.setting+'['+index+']';return React.createElement('li',{className:'clearfix '+this.props.id+'_components-item','data-title':item.text||item.title,'data-component':item.element||item.title},React.createElement('i',{className:'fa fa-ellipsis-v sortable-handler'+this.props.id+'_components-handler'}),React.createElement('i',{className:'fa fa-ellipsis-v sortable-handler'+this.props.id+'_components-handler'}),item.id?React.createElement('input',{type:'hidden',name:name,value:item.id}):React.createElement('input',{type:'hidden',name:name+'[title]',value:item.title}),item.id?React.createElement('span',{className:'menu-item'},item.text):React.createElement('span',{className:'menu-item',title:api.Text.parse('click-to-edit-group-title'),contentEditable:'true',onKeyDown:this.editGroup.bind(this,index)},item.title),React.createElement('a',{href:'javascript:void(0)',onClick:this.editPermissions,className:'item-action'},React.createElement('i',{className:'fa fa-wrench'})),item.id||item.items&&item.items.length?null:React.createElement('a',{href:'javascript:void(0)',onClick:this.removeGroup.bind(this,index),className:'item-action'},React.createElement('i',{className:'fa fa-trash'})),item.id?null:React.createElement('ul',{id:'group-'+api.Text.toId(item.title),className:'item-list'},item.items&&item.items.length?item.items.map(subItem=>{var subName=name+'[items][]';return React.createElement('li',{className:'clearfix group-'+api.Text.toId(item.title)+'-item','data-title':subItem.text,'data-component':subItem.element},React.createElement('i',{className:'fa fa-ellipsis-v sortable-handler group-'+api.Text.toId(item.title)+'-handler'}),React.createElement('i',{className:'fa fa-ellipsis-v sortable-handler group-'+api.Text.toId(item.title)+'-handler'}),React.createElement('input',{type:'hidden',name:subName,value:subItem.id}),React.createElement('span',{className:'menu-item'},subItem.text),React.createElement('a',{href:'javascript:void(0)',onClick:this.editPermissions,className:'item-action'},React.createElement('i',{className:'fa fa-wrench'})));}):React.createElement('li',{className:'placeholder text-muted'},api.Text.parse('drop-menu-item-here-to-add-to-group'))));}))))));},componentWillUpdate:function(){this.deinitSortable();},componentDidUpdate:function(){this.parent();this.initSortable();},componentWillUnmount:function(){this.parent();this.deinitSortable();},initSortable:function(){if(typeof window.sortable=='function'&&this.refs.mountedDOMNode){var lists=this.refs.mountedDOMNode.querySelectorAll('.item-list');for(var i=0;i<lists.length;i++){var id=lists[i].getAttribute('id');(this.sortable=this.sortable||{})[id]=sortable(lists[i],{connectWith:this.props.id+'_'+this.props.setting,items:'.'+id+'-item',handle:'.'+id+'-handler',forcePlaceholderSize:true});api.Event.add(this.sortable[id][0],'sortupdate',this.handleSort);}}},deinitSortable:function(){if(this.sortable){var lists=this.refs.mountedDOMNode.querySelectorAll('.item-list');for(var i=0;i<lists.length;i++){var id=lists[i].getAttribute('id');if(this.sortable[id]){api.Event.remove(this.sortable[id][0],'sortupdate',this.handleSort);sortable(lists[i],'destroy');}}delete this.sortable;}},handleSort:function(event){if(event.detail.startparent!=event.detail.endparent){var placeholder=event.detail.item.parentNode.querySelector('.placeholder');if(placeholder){event.detail.item.parentNode.removeChild(placeholder);}this.rebuildMenuItems();}else{this.rebuildMenuItems();}},addGroup:function(){var modal=api.Modal.get({type:'html',title:api.Text.parse('add-new-component-menu-group'),content:React.createElement('div',{key:api.Text.toId('new_group_',true),className:'form-group'},React.createElement(api.ElementInput,{type:'text',name:'new_group',value:'',className:'form-control',placeholder:api.Text.parse('new-component-menu-group-hint')})),width:'66%',height:0,centralize:false,onModalShown:function(event){var input=event.target.refs.mountedDOMNode.querySelector('input');if(input){input.focus();}},confirm:function(modal){modal.close();var items=JSON.parse(JSON.stringify(this.state.items||this.config.items));items.unshift({title:modal.refs.mountedDOMNode.querySelector('input').value,items:[]});this.state.items=items;this.state.itemListKey=api.Text.toId('itemList',true);this.triggerChange();}.bind(this)});},editGroup:function(index,event){if(event.keyCode==13){event.preventDefault();var value=event.target.innerHTML.trim();event.target.parentNode.querySelector('input').value=value;(this.state.items||this.config.items)[index].title=value;event.target.blur();this.triggerChange();}else if(event.keyCode==27){event.preventDefault();document.execCommand('undo');event.target.blur();}},removeGroup:function(index,event){var items=JSON.parse(JSON.stringify(this.state.items||this.config.items)),group=items[index];if(group.items&&group.items.length){api.Modal.alert(api.Text.parse('cannot-remove-non-empty-group'));}else{items.splice(index,1);this.state.items=items;this.state.itemListKey=api.Text.toId('itemList',true);this.triggerChange();}},rebuildMenuItems:function(){var items=[],item;for(var i=0;i<this.refs.items.children.length;i++){var input=this.refs.items.children[i].querySelector('input'),subItems=this.refs.items.children[i].querySelectorAll('.item-list>li');if(!subItems.length){if(item=this.getMenuItem(input.value)){input.name=this.props.setting+'['+i+']';items.push(item);}else{items.push({title:input.value,items:[]});}}else{input.name=this.props.setting+'['+i+'][title]';item={title:input.value,items:[]};for(var j=0;j<subItems.length;j++){if(!subItems[j].classList.contains('placeholder')){input=subItems[j].querySelector('input');input.name=this.props.setting+'['+i+'][items][]';item.items.push(this.getMenuItem(input.value));}}items.push(item);}}this.state.items=items;this.state.itemListKey=api.Text.toId('itemList',true);this.triggerChange();},getMenuItem:function(id,items){items=items||this.config.items;var item;for(var i=0;i<items.length;i++){if(id==items[i].id){return items[i];}else if(items[i].items){if(item=this.getMenuItem(id,items[i].items)){return item;}}}},triggerChange:function(){var value=[];this.state.items.map(item=>{if(item.id){value.push(item.id);}else{var items=[];for(var i=0;i<item.items.length;i++){items.push(item.items[i].id);}value.push({items:items,title:item.title});}});this.change(this.props.setting,value);},editPermissions:function(event,force){var target=event.target;while(target&&target.nodeName!='LI'&&target.nodeName!='BODY'){target=target.parentNode;}if(!target||target.nodeName=='BODY'){return;}if(!force&&target.getAttribute('data-component').indexOf('com_')<0){var button=document.querySelector(this.config.saveButton);if(button&&!button.disabled){var item=event.target;return api.Modal.confirm(api.Text.parse('confirm-save-change'),function(modal){jQuery(button).trigger('click');var event={target:item};this.editPermissions(event,true);}.bind(this));}}this.modal=api.Modal.get({type:'iframe',title:this.config.actions.permission.modalTitle.replace('{title}',target.getAttribute('data-title')),content:{src:this.config.actions.permission.href.replace('{component}',target.getAttribute('data-component')),onLoad:function(event){if(target.getAttribute('data-component').indexOf('com_')<0){event.target.contentWindow.jQuery(document).ajaxComplete(function(event,xhr,opts){if(opts.data.indexOf('action=core.view.component.group.')>-1){var components=target.querySelectorAll('li[data-component]');if(components.length){var params=opts.data.split("&"),data={};for(var i=0;i<params.length;i++){var pairs=params[i].split("=");data[pairs[0]]=pairs[1];}(function propagate(i){if(i<components.length){data.comp=data.title=components[i].getAttribute('data-component');data.action='core.manage';api.Ajax.request(opts.url,function(res){setTimeout(function(){propagate(++i);},10);},data);}})(0);}}});}}},width:'90%',height:'90%',buttons:[{text:api.Text.parse('close'),onClick:function(modal){modal.close();}}]});}});